'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.errorCodes = undefined;

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

exports.createHTTPHandler = createHTTPHandler;

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _rawBody = require('raw-body');

var _rawBody2 = _interopRequireDefault(_rawBody);

var _querystring = require('querystring');

var _querystring2 = _interopRequireDefault(_querystring);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _tsscmp = require('tsscmp');

var _tsscmp2 = _interopRequireDefault(_tsscmp);

var _util = require('./util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var debug = (0, _debug2.default)('@slack/interactive-messages:http-handler');

var errorCodes = exports.errorCodes = {
  SIGNATURE_VERIFICATION_FAILURE: 'SLACKHTTPHANDLER_REQUEST_SIGNATURE_VERIFICATION_FAILURE',
  REQUEST_TIME_FAILURE: 'SLACKHTTPHANDLER_REQUEST_TIMELIMIT_FAILURE'
};

function createHTTPHandler(adapter) {
  var poweredBy = (0, _util.packageIdentifier)();

  /**
   * Handles sending responses
   *
   * @param {Object} res - Response object
   * @returns {Function} Returns a function used to send response
   */
  function sendResponse(res) {
    return function _sendResponse(dispatchResult) {
      var status = dispatchResult.status,
          content = dispatchResult.content;

      res.statusCode = status;
      res.setHeader('X-Slack-Powered-By', poweredBy);
      if (typeof content === 'string') {
        res.end(content);
      } else if (content) {
        res.setHeader('Content-Type', 'application/json');
        res.end(JSON.stringify(content));
      } else {
        res.end();
      }
    };
  }

  /**
   * Parses raw bodies of requests
   *
   * @param {string} body - Raw body of request
   * @returns {Object} Parsed body of the request
   */
  function parseBody(body) {
    var parsedBody = _querystring2.default.parse(body);
    if (parsedBody.payload) {
      return JSON.parse(parsedBody.payload);
    }

    return parsedBody;
  }

  /**
   * Method to verify signature of requests
   *
   * @param {string} signingSecret - Signing secret used to verify request signature
   * @param {Object} requestHeaders - Request headers
   * @param {string} body - Raw body string
   * @returns {boolean} Indicates if request is verified
   */
  function verifyRequestSignature(signingSecret, requestHeaders, body) {
    // Request signature
    var signature = requestHeaders['x-slack-signature'];
    // Request timestamp
    var ts = requestHeaders['x-slack-request-timestamp'];

    // Divide current date to match Slack ts format
    // Subtract 5 minutes from current time
    var fiveMinutesAgo = Math.floor(Date.now() / 1000) - 60 * 5;

    if (ts < fiveMinutesAgo) {
      debug('request is older than 5 minutes');
      var error = new Error('Slack request signing verification failed');
      error.code = errorCodes.REQUEST_TIME_FAILURE;
      throw error;
    }

    var hmac = _crypto2.default.createHmac('sha256', signingSecret);

    var _signature$split = signature.split('='),
        _signature$split2 = _slicedToArray(_signature$split, 2),
        version = _signature$split2[0],
        hash = _signature$split2[1];

    hmac.update(`${version}:${ts}:${body}`);

    if (!(0, _tsscmp2.default)(hash, hmac.digest('hex'))) {
      debug('request signature is not valid');
      var _error = new Error('Slack request signing verification failed');
      _error.code = errorCodes.SIGNATURE_VERIFICATION_FAILURE;
      throw _error;
    }

    debug('request signing verification success');
    return true;
  }

  /**
   * Request listener used to handle Slack requests and send responses and
   * verify request signatures
   *
   * @param {Object} req - Request object
   * @param {Object} res - Response object
   */
  return function slackRequestListener(req, res) {
    debug('request received - method: %s, path: %s', req.method, req.url);
    // Function used to send response
    var respond = sendResponse(res);

    // Builds body of the request from stream and returns the raw request body
    (0, _rawBody2.default)(req).then(function (r) {
      var rawBody = r.toString();

      if (verifyRequestSignature(adapter.signingSecret, req.headers, rawBody)) {
        // Request signature is verified
        // Parse raw body
        var body = parseBody(rawBody);

        if (body.ssl_check) {
          respond({ status: 200 });
          return;
        }

        var dispatchResult = adapter.dispatch(body);

        if (dispatchResult) {
          dispatchResult.then(respond);
        } else {
          // No callback was matched
          debug('no callback was matched');
          respond({ status: 404 });
        }
      }
    }).catch(function (error) {
      if (error.code === errorCodes.SIGNATURE_VERIFICATION_FAILURE || error.code === errorCodes.REQUEST_TIME_FAILURE) {
        respond({ status: 404 });
      } else if (process.env.NODE_ENV === 'development') {
        respond({ status: 500, content: error.message });
      } else {
        respond({ status: 500 });
      }
    });
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odHRwLWhhbmRsZXIuanMiXSwibmFtZXMiOlsiY3JlYXRlSFRUUEhhbmRsZXIiLCJkZWJ1ZyIsImVycm9yQ29kZXMiLCJTSUdOQVRVUkVfVkVSSUZJQ0FUSU9OX0ZBSUxVUkUiLCJSRVFVRVNUX1RJTUVfRkFJTFVSRSIsImFkYXB0ZXIiLCJwb3dlcmVkQnkiLCJzZW5kUmVzcG9uc2UiLCJyZXMiLCJfc2VuZFJlc3BvbnNlIiwiZGlzcGF0Y2hSZXN1bHQiLCJzdGF0dXMiLCJjb250ZW50Iiwic3RhdHVzQ29kZSIsInNldEhlYWRlciIsImVuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJwYXJzZUJvZHkiLCJib2R5IiwicGFyc2VkQm9keSIsInF1ZXJ5c3RyaW5nIiwicGFyc2UiLCJwYXlsb2FkIiwidmVyaWZ5UmVxdWVzdFNpZ25hdHVyZSIsInNpZ25pbmdTZWNyZXQiLCJyZXF1ZXN0SGVhZGVycyIsInNpZ25hdHVyZSIsInRzIiwiZml2ZU1pbnV0ZXNBZ28iLCJNYXRoIiwiZmxvb3IiLCJEYXRlIiwibm93IiwiZXJyb3IiLCJFcnJvciIsImNvZGUiLCJobWFjIiwiY3J5cHRvIiwiY3JlYXRlSG1hYyIsInNwbGl0IiwidmVyc2lvbiIsImhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJzbGFja1JlcXVlc3RMaXN0ZW5lciIsInJlcSIsIm1ldGhvZCIsInVybCIsInJlc3BvbmQiLCJ0aGVuIiwiciIsInJhd0JvZHkiLCJ0b1N0cmluZyIsImhlYWRlcnMiLCJzc2xfY2hlY2siLCJkaXNwYXRjaCIsImNhdGNoIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwibWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O1FBY2dCQSxpQixHQUFBQSxpQjs7QUFkaEI7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUEsSUFBTUMsUUFBUSxxQkFBYSwwQ0FBYixDQUFkOztBQUVPLElBQU1DLGtDQUFhO0FBQ3hCQyxrQ0FBZ0Ms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YnVnRmFjdG9yeSBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZ2V0UmF3Qm9keSBmcm9tICdyYXctYm9keSc7XG5pbXBvcnQgcXVlcnlzdHJpbmcgZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHRpbWluZ1NhZmVDb21wYXJlIGZyb20gJ3Rzc2NtcCc7XG5pbXBvcnQgeyBwYWNrYWdlSWRlbnRpZmllciB9IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IGRlYnVnID0gZGVidWdGYWN0b3J5KCdAc2xhY2svaW50ZXJhY3RpdmUtbWVzc2FnZXM6aHR0cC1oYW5kbGVyJyk7XG5cbmV4cG9ydCBjb25zdCBlcnJvckNvZGVzID0ge1xuICBTSUdOQVRVUkVfVkVSSUZJQ0FUSU9OX0ZBSUxVUkU6ICdTTEFDS0hUVFBIQU5ETEVSX1JFUVVFU1RfU0lHTkFUVVJFX1ZFUklGSUNBVElPTl9GQUlMVVJFJyxcbiAgUkVRVUVTVF9USU1FX0ZBSUxVUkU6ICdTTEFDS0hUVFBIQU5ETEVSX1JFUVVFU1RfVElNRUxJTUlUX0ZBSUxVUkUnLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUhUVFBIYW5kbGVyKGFkYXB0ZXIpIHtcbiAgY29uc3QgcG93ZXJlZEJ5ID0gcGFja2FnZUlkZW50aWZpZXIoKTtcblxuICAvKipcbiAgICogSGFuZGxlcyBzZW5kaW5nIHJlc3BvbnNlc1xuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVzIC0gUmVzcG9uc2Ugb2JqZWN0XG4gICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBhIGZ1bmN0aW9uIHVzZWQgdG8gc2VuZCByZXNwb25zZVxuICAgKi9cbiAgZnVuY3Rpb24gc2VuZFJlc3BvbnNlKHJlcykge1xuICAgIHJldHVybiBmdW5jdGlvbiBfc2VuZFJlc3BvbnNlKGRpc3BhdGNoUmVzdWx0KSB7XG4gICAgICBjb25zdCB7IHN0YXR1cywgY29udGVudCB9ID0gZGlzcGF0Y2hSZXN1bHQ7XG4gICAgICByZXMuc3RhdHVzQ29kZSA9IHN0YXR1cztcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtU2xhY2stUG93ZXJlZC1CeScsIHBvd2VyZWRCeSk7XG4gICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlcy5lbmQoY29udGVudCk7XG4gICAgICB9IGVsc2UgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgICAgcmVzLmVuZChKU09OLnN0cmluZ2lmeShjb250ZW50KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuZW5kKCk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZXMgcmF3IGJvZGllcyBvZiByZXF1ZXN0c1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYm9keSAtIFJhdyBib2R5IG9mIHJlcXVlc3RcbiAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGJvZHkgb2YgdGhlIHJlcXVlc3RcbiAgICovXG4gIGZ1bmN0aW9uIHBhcnNlQm9keShib2R5KSB7XG4gICAgY29uc3QgcGFyc2VkQm9keSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKGJvZHkpO1xuICAgIGlmIChwYXJzZWRCb2R5LnBheWxvYWQpIHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKHBhcnNlZEJvZHkucGF5bG9hZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcnNlZEJvZHk7XG4gIH1cblxuICAvKipcbiAgICogTWV0aG9kIHRvIHZlcmlmeSBzaWduYXR1cmUgb2YgcmVxdWVzdHNcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNpZ25pbmdTZWNyZXQgLSBTaWduaW5nIHNlY3JldCB1c2VkIHRvIHZlcmlmeSByZXF1ZXN0IHNpZ25hdHVyZVxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdEhlYWRlcnMgLSBSZXF1ZXN0IGhlYWRlcnNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJvZHkgLSBSYXcgYm9keSBzdHJpbmdcbiAgICogQHJldHVybnMge2Jvb2xlYW59IEluZGljYXRlcyBpZiByZXF1ZXN0IGlzIHZlcmlmaWVkXG4gICAqL1xuICBmdW5jdGlvbiB2ZXJpZnlSZXF1ZXN0U2lnbmF0dXJlKHNpZ25pbmdTZWNyZXQsIHJlcXVlc3RIZWFkZXJzLCBib2R5KSB7XG4gICAgLy8gUmVxdWVzdCBzaWduYXR1cmVcbiAgICBjb25zdCBzaWduYXR1cmUgPSByZXF1ZXN0SGVhZGVyc1sneC1zbGFjay1zaWduYXR1cmUnXTtcbiAgICAvLyBSZXF1ZXN0IHRpbWVzdGFtcFxuICAgIGNvbnN0IHRzID0gcmVxdWVzdEhlYWRlcnNbJ3gtc2xhY2stcmVxdWVzdC10aW1lc3RhbXAnXTtcblxuICAgIC8vIERpdmlkZSBjdXJyZW50IGRhdGUgdG8gbWF0Y2ggU2xhY2sgdHMgZm9ybWF0XG4gICAgLy8gU3VidHJhY3QgNSBtaW51dGVzIGZyb20gY3VycmVudCB0aW1lXG4gICAgY29uc3QgZml2ZU1pbnV0ZXNBZ28gPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSAtICg2MCAqIDUpO1xuXG4gICAgaWYgKHRzIDwgZml2ZU1pbnV0ZXNBZ28pIHtcbiAgICAgIGRlYnVnKCdyZXF1ZXN0IGlzIG9sZGVyIHRoYW4gNSBtaW51dGVzJyk7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignU2xhY2sgcmVxdWVzdCBzaWduaW5nIHZlcmlmaWNhdGlvbiBmYWlsZWQnKTtcbiAgICAgIGVycm9yLmNvZGUgPSBlcnJvckNvZGVzLlJFUVVFU1RfVElNRV9GQUlMVVJFO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuXG4gICAgY29uc3QgaG1hYyA9IGNyeXB0by5jcmVhdGVIbWFjKCdzaGEyNTYnLCBzaWduaW5nU2VjcmV0KTtcbiAgICBjb25zdCBbdmVyc2lvbiwgaGFzaF0gPSBzaWduYXR1cmUuc3BsaXQoJz0nKTtcbiAgICBobWFjLnVwZGF0ZShgJHt2ZXJzaW9ufToke3RzfToke2JvZHl9YCk7XG5cbiAgICBpZiAoIXRpbWluZ1NhZmVDb21wYXJlKGhhc2gsIGhtYWMuZGlnZXN0KCdoZXgnKSkpIHtcbiAgICAgIGRlYnVnKCdyZXF1ZXN0IHNpZ25hdHVyZSBpcyBub3QgdmFsaWQnKTtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdTbGFjayByZXF1ZXN0IHNpZ25pbmcgdmVyaWZpY2F0aW9uIGZhaWxlZCcpO1xuICAgICAgZXJyb3IuY29kZSA9IGVycm9yQ29kZXMuU0lHTkFUVVJFX1ZFUklGSUNBVElPTl9GQUlMVVJFO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuXG4gICAgZGVidWcoJ3JlcXVlc3Qgc2lnbmluZyB2ZXJpZmljYXRpb24gc3VjY2VzcycpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlcXVlc3QgbGlzdGVuZXIgdXNlZCB0byBoYW5kbGUgU2xhY2sgcmVxdWVzdHMgYW5kIHNlbmQgcmVzcG9uc2VzIGFuZFxuICAgKiB2ZXJpZnkgcmVxdWVzdCBzaWduYXR1cmVzXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXEgLSBSZXF1ZXN0IG9iamVjdFxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVzIC0gUmVzcG9uc2Ugb2JqZWN0XG4gICAqL1xuICByZXR1cm4gZnVuY3Rpb24gc2xhY2tSZXF1ZXN0TGlzdGVuZXIocmVxLCByZXMpIHtcbiAgICBkZWJ1ZygncmVxdWVzdCByZWNlaXZlZCAtIG1ldGhvZDogJXMsIHBhdGg6ICVzJywgcmVxLm1ldGhvZCwgcmVxLnVybCk7XG4gICAgLy8gRnVuY3Rpb24gdXNlZCB0byBzZW5kIHJlc3BvbnNlXG4gICAgY29uc3QgcmVzcG9uZCA9IHNlbmRSZXNwb25zZShyZXMpO1xuXG4gICAgLy8gQnVpbGRzIGJvZHkgb2YgdGhlIHJlcXVlc3QgZnJvbSBzdHJlYW0gYW5kIHJldHVybnMgdGhlIHJhdyByZXF1ZXN0IGJvZHlcbiAgICBnZXRSYXdCb2R5KHJlcSlcbiAgICAgIC50aGVuKChyKSA9PiB7XG4gICAgICAgIGNvbnN0IHJhd0JvZHkgPSByLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgaWYgKHZlcmlmeVJlcXVlc3RTaWduYXR1cmUoYWRhcHRlci5zaWduaW5nU2VjcmV0LCByZXEuaGVhZGVycywgcmF3Qm9keSkpIHtcbiAgICAgICAgICAvLyBSZXF1ZXN0IHNpZ25hdHVyZSBpcyB2ZXJpZmllZFxuICAgICAgICAgIC8vIFBhcnNlIHJhdyBib2R5XG4gICAgICAgICAgY29uc3QgYm9keSA9IHBhcnNlQm9keShyYXdCb2R5KTtcblxuICAgICAgICAgIGlmIChib2R5LnNzbF9jaGVjaykge1xuICAgICAgICAgICAgcmVzcG9uZCh7IHN0YXR1czogMjAwIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGRpc3BhdGNoUmVzdWx0ID0gYWRhcHRlci5kaXNwYXRjaChib2R5KTtcblxuICAgICAgICAgIGlmIChkaXNwYXRjaFJlc3VsdCkge1xuICAgICAgICAgICAgZGlzcGF0Y2hSZXN1bHQudGhlbihyZXNwb25kKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gTm8gY2FsbGJhY2sgd2FzIG1hdGNoZWRcbiAgICAgICAgICAgIGRlYnVnKCdubyBjYWxsYmFjayB3YXMgbWF0Y2hlZCcpO1xuICAgICAgICAgICAgcmVzcG9uZCh7IHN0YXR1czogNDA0IH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIGlmIChlcnJvci5jb2RlID09PSBlcnJvckNvZGVzLlNJR05BVFVSRV9WRVJJRklDQVRJT05fRkFJTFVSRSB8fFxuICAgICAgICAgIGVycm9yLmNvZGUgPT09IGVycm9yQ29kZXMuUkVRVUVTVF9USU1FX0ZBSUxVUkUpIHtcbiAgICAgICAgICByZXNwb25kKHsgc3RhdHVzOiA0MDQgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgICByZXNwb25kKHsgc3RhdHVzOiA1MDAsIGNvbnRlbnQ6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzcG9uZCh7IHN0YXR1czogNTAwIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfTtcbn1cbiJdfQ==
//# sourceMappingURL=http-handler.js.map